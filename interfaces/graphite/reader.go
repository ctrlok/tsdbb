package graphite

import (
	"bufio"
	"io"
	"io/ioutil"
	"net"
	"net/url"
	"time"

	"github.com/ctrlok/tsdbb/interfaces"
	"github.com/davecgh/go-spew/spew"
)

// Metric is a
type Metric [4][2]byte

// Internal is tuple method for Metric interface
func (m *Metric) Internal() interface{} {
	return ""
}

// PregeneratedMetrics is a struct which contain Metric, and generated by TSDB.GenerateMetrics
type PregeneratedMetrics struct {
	metrics []Metric
	err     error
}

// Metric return metric or out of index error
func (p *PregeneratedMetrics) Metric(i int) (interfaces.Metric, error) {
	if i >= len(p.metrics) {
		return &Metric{}, p.err
	}
	return &p.metrics[i], nil
}

// TSDB is a main generator of graphite Metric and Sender
type TSDB struct {
	GeneratorPrefix []byte
	DevNull         bool
}

// GenerateMetrics is a method for create PregeneratedMetrics
func (t *TSDB) GenerateMetrics(i int) interfaces.PregeneratedMetrics {
	p := PregeneratedMetrics{}
	p.metrics = make([]Metric, i)
	for i := range p.metrics[0] {
		p.metrics[0][i][0] = 48
		p.metrics[0][i][1] = 48
	}
	for n := 1; n < i; n++ {
		var plus byte = 1
		for k := 3; k > -1; k-- {
			for m := 1; m > -1; m-- {
				if plus == 1 {
					if p.metrics[n-1][k][m] == 57 {
						p.metrics[n][k][m] = 48
					} else {
						p.metrics[n][k][m] = p.metrics[n-1][k][m] + plus
						plus = 0
					}
				} else {
					p.metrics[n][k][m] = p.metrics[n-1][k][m]
				}
			}
		}
	}
	return &p
}

// NewSender will create new sender
func (t *TSDB) NewSender(uri *url.URL) (s interfaces.Sender, err error) {
	sender := Sender{}
	if t.DevNull {
		// sender.f, _ = os.OpenFile("/tmp/metricTEst", os.O_RDWR, 0755)
		sender.f = ioutil.Discard
		sender.w = bufio.NewWriter(sender.f)
		return &sender, nil
	}
	addr, err := net.ResolveTCPAddr(uri.Scheme, uri.Host)
	if err != nil {
		return nil, err
	}
	conn, err := net.DialTCP(uri.Scheme, nil, addr)
	spew.Dump(conn)
	if err != nil {
		return nil, err
	}
	sender.f = conn
	sender.w = bufio.NewWriter(sender.f)
	return &sender, err
}

// Sender is a sender instance.
type Sender struct {
	w      *bufio.Writer
	f      io.Writer
	prefix []byte

	host string
}

// Send is a method for sending messages. Work only with internal Metric
func (s *Sender) Send(metric interfaces.Metric, t *time.Time) (err error) {
	m := metric.(*Metric)
	_, err = s.w.Write(s.prefix)
	if err != nil {
		return err
	}
	for i := 0; i < 4; i++ {
		err = s.w.WriteByte(46) // dot
		if err != nil {
			return err
		}
		err = s.w.WriteByte(m[i][0])
		if err != nil {
			return err
		}
		err = s.w.WriteByte(m[i][1])
		if err != nil {
			return err
		}
		// s.w.Flush()
	}
	err = s.w.WriteByte(10) // newline
	return err
}

// GetHost will return host of sender
func (s *Sender) GetHost() string {
	return s.host
}
